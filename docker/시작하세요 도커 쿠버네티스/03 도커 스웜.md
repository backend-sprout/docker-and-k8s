# 도커 스웜 
# 도커 스웜을 사용하는 이유 

하나의 호스트 머신에서 도커 엔진을 구동하다가 CPU 메모리, 디스크 용량과 같은 자원이 부족하면 

* 스케일 업 
* 스케일 아웃(클러스터로 구성)
 
서버를 병렬로 확장해나가면     
적당한 성능의 서버 여러대를 하나의 자원 풀을 만들어 사용할 수 있고 성능이 좋은 값 비싼 서버를 사지 않아도 된다.         

**그러나, 여러대의 서버를 하나의 자원 풀로 만드는 것은 쉬운 작업이 아니다.**       
새로운 서버나 컨테이너가 추가됐을 때 이를 발견(Service Discovery)하는 작업부터   
어떤 서버에 컨테이너를 할당할 것인가에 대한 스케줄러와 로드밸런서 문제,      
클러스터 내의 서버가 다운 됐을 때 **고가용성**을 어떻게 보장할지 등이 문제로 남아있다.      

다행히도 이러한 문제를 해결하는 여러 솔루션을 오픈소스로 활용할 수 있는데   
도커에서 공식적으로 제공하는 도커스웜과 스웜모드가 대표적이다.   

# 스웜 클래식과 도커 스웜 모드 

스웜 클래식/스웜 모드는 여러 대의 도커 서버를 하나의 클러스터로 만들어 컨테이너를 생성하는 여러 기능을 제공한다.       
컨테이너를 특정 도커 서버에 할당할 수 있고 유동적으로 서버를 확장시킬 수도 있다.    
그뿐만 아니라 스웜 클러스터에 등록된 서버의 컨테이너를 쉽게 관리할 수 있다.   
(서버 클러스터에서 컨테이너를 어떻게 다룰 수 있는지 기초적인 지식 쌓기에 적합하다.)   

도커 스웜에는 2가지 종류가 있다.   

1. 스웜 클래식 : 도커 버전 1.6 이후부터 사용할 수 있는 컨테이너로서의 스웜
2. 스웜 모드 : 도커 버전 1.12 이후부터 사용할 수 있는 도커 스웜 모드(Swarm)

## 스웜 클래식과 도커 스웜 모드의 목적

두 종류의 가장 큰 차이점은 **목적**이다.  
  
* 스웜 클래식 : 
    * 여러 도커 서버를 하나의 지점에서 사용하도록 단일 접근점을 제공    
    * docker run, docker ps 등 일반적인 도커 명령어와 도커 API로 클러스터의 서버를 제어하고 관리할 수 있음  
* 스웜 모드 : 
    * 마이크로 서비스 아키텍처의 컨테이너를 다루기 위한 클러스터링 기능에 초점  
    * 같은 컨테이너를 동시에 여러 개 생성해 필요에 따라 유동적으로 컨테이너의 수를 조절 

상황에 맞추어 사용하면 되지만, 스웤 모드가 확장성 안정성 등 여러 측면에서 비교적 뛰어나기에 스웜 모드 사용  

## 분산 코디네이터
> 에이전트와 같은 클러스터 툴이 별도로 구동 되느냐   

여러개의 도커 서버를 하나의 클러스터로 구성하려면 각종 정보를 저장하고 동기화하는 분산 코디네이터,   
클러스터 내의 서버를 관리하고 제어하는 매니저, 각 서버를 제어하는 에이전트가 반드시 있어야 한다.  

* 스웜 클래식 : 분산 코디네이터, 에에전트등이 별도로 실행되어야함  
* 스웜 모드 : 클러스터링을 위한 모든 도구가 도커 엔진 자체에 내장돼있어 쉽게 서버 클러스터 구축이 가능하다.  

```
분산 코디네이터는 클러스터에 영입할 새로운 서버의 발견, 클러스터의 각종 설정 저장, 데이터 동기화 등에 주로 이용된다.   
etcd, zookeeper, consul등이 대표적인 예이며, 스웜 클래식은 대부분 분산 코디네이터를 사용할 수 있다.    
스웜 모드는 분산 코디네이터를 별도로 구축하지 않아도 된다.
```

대규모 클러스터에서 서비스를 운영하는 것을 계획하고 있다면 스웜 클래식보다는 스웜 모드를 사용하는 것이 좋다.  
스웜 모드는 MSA 애플리케이션을 컨테이너로 구축할 수 있도록 도와줄 뿐만 아니라,       
**서비스 장애에 대비한 고가용성과 부하 분산을 위한 로드 밸런싱 기능 또한 제공하고 있기 때문이다.**   
(스웜 클래식도 가능하지만 스웜 모드를 추천)  

# 스웜 모드 
  
스웜 모드는 별도의 설치 고자ㅓㅇ이 필요하지 않으며, 도커 엔진 자체에 내장돼어 있다.(기본은 비활성화)   

```shell
docker info | grep Swarm
Swarm: inactive // 비활성화 
```

## 도커 스웜 모드 구조 

스웜 모드는 매니저 노드와 워커 노드로 구성되어 있다.  

* 매니저 노드 : 워커 노드를 관리하는 도커 서버(워커로도 사용 가능)     
* 워커 노드 : 실제로 컨테이너가 생성되고 관리되는 도커 서버  

[#](#) 

기본적으로 매니저 노드는 한 개 이상 있어야 한다.    
노드가 2개이상이 될 경우, 매니저 노드와 워커 노드를 분리해서 사용하는 것이 좋다.(매니저1, 워커2)    
운영에서 사용하려면 매니저 노드를 이중화하는 것을 추천한다.(고가용성)  

스웜 모드는 매니저 노드의 절반 이상에 장애가 생겨 정상적으로 작동하지 못할 경우    
장애가 생긴 매니저 노드가 복구될 때까지 클러스터의 운영을 중단한다.    
 
만약, 매니저 노드 사이에 네트워크 파티셔닝과 같은 현상이 발생했을 경우,      
짝수 개의 매니저로 구성한 클러스터는 운영이 중단될 수 도 있지만,     
홀수 개로 구성햇을 경우에는 과반수 이상이 유지되는 쿼럼 매니저에 운영을 계속할 수 있다.   


## 도커 스웜 모드 클러스터 구축 

```
swarm-manager 192.168.0.100
swarm-worker1 192.168.0.101
swarm-worker2 192.168.0.102
```
```
docker swarm init --advertise-addr 192.168.0.100

Swarminitialized : ~~
To add a worker ~~~
    docker swarm join \
    --token ~~~ \
    IP
    
To add a manager to ~~    
```
* `docker swarm init --advertise-addr {IP}` 를 통해 매니저 노드를 실행시킨다.
* 만약 매니저 노드가 2개 이상의 네트워크 인터페이스르 가지고 있다면,      
  어느 IP 주소로 매니저에 접근해야할지 다른 노드에 알려줄 필요가 있다.   
* 출력 결과중 `docker swarm join` 이라는 명령어는 새로운 워커 노드를 스웜 클러스터에 추가할 때 사용한다.       
  `--token` 옵션에 사용된 토큰 값은 새로운 노드를 해당 스웜 클러스터에 추가하기 위한 비밀키다.    

```
스웜 매니저는 기본적으로 2377번 포트를 사용하며,    
노드 사이의 통신에 7956/tcp, 7946/udp 포트를 스웜이 사용하는 네트워크인 ingress 오버레이 네트워크에   
4789/tcp, 4789/udp 포트를 사용한다.   
스웜 클러스터를 구성하기 전에 이러한 포트를 각 호스트 머신에서 열어두는 것을 잊지말자  
```

위 출력 결과에서의 토큰을 이용해 워커 노드를 등록하고자 한다면 아래와 같다.  

```
워커 노드 서버>> 

docker swarm join \
--token {{토큰}}
{{매니저 노드 IP}}
```
* 각 워커노드마다 실행해야 한다.  

```
> 매니저 노드 

docker node ls
ID      HOSTNAME      STATUS      AVAILABILITY      MANAGER      STATUS
~
```
* 스웜 클러스터에 어떤 워커 노드가 추가되었는지 확인하기 위해서,   
  매니저 노드에 `docker node ls`를 입력하면 알 수 있다.     
   
매니저 노드는 일반적으로 매니저 역할을 하는 노드와 리더 역할을 하는 노드로 나뉜다.      
리더 매니저는 모든 매니저 노드에 대한 데이터 도익화와 관리를 담당하므로 항상 작동할 수 있는 상태여야한다.      
리더 매니저의 서버가 다운되는 등의 장애가 생기면 매니저는 새로운 리더를 선출하는데, 이 때 Raft Consensus 알고리즘을 사용한다.     
Raft Consensus 알고리즘은 리더 선출 및 고가용성 보장을 위한 알고리즘이다.     
한개의 매니저만 존재할 경우, 해당 노드가 리더가 된다.    
  
```
docker swarm join-token manager  

    docker swrm join \
    --token {{토큰}}
    {{리더매니저IP:2377}}
```

새로운 매니저 추가는 기존 매니저 노드에서 위 명령어를 통해 확인이 가능하다.  

```
docker swarm join join-token --rotate {{manager/~~}} 
```

토큰은 가급적 공개되지 않아야하고 주기적으로 변경을 해주는 것이 좋다.     
* 매니저 노드에서 위와 같은 명령어를 입력하면 토큰 변경이 이루어진다.     
* `--rotate` 명령어 뒤에 변경할 토큰의 대상을 입력하면 된다.     
     

```shell
docker swarm leave
docker node rm swarm-node -1  
```
* 만약, 스웜 모드를 해제하고 싶다면 아래 명령어를 입력한다.    
* 단, 매니저 노드는 워커 노드를 DOWN 으로 인지할 뿐 워커 노드를 삭제하지 않으므로 docker node rm 명령어를 입력해주어야한다.    

```
docker swarm leave --force
```
* 참고로 매니저 노드는 --force 옵션을 붙여야 삭제가 가능하다.  
* 매니저 노드를 스웜 클러스터에서 삭제하면, 클러스터 정보도 삭제되므로 주의하자.   

```
docker node promote swarm-worker1
docker node demote swarm-worker1
```
* 워커 노드를 매니저 노드로 변경하려면 docker node promote 명령어를 사용한다.   
* 매니저 노드를 워커 노드로 변경하려면 docker node demote 명령어를 사용한다.   
* 단, 매니저 노드가 한개일때, demote 는 불가능하다.    

## 스웜 모드 서비스 
### 스웜 모드 서비스 개념

지금까지 사용해온 도커 명령어의 제어 단위는 컨테이너다.    
스웜 모드에서 제어하는 단위는 컨테이너가 아닌 **서비스이다.**   
 
**서비스란?**       
* 같은 이미지에서 생성된 컨테이너의 집합     
* 서비스를 제어하면 해당 서비스 내의 컨테이너에 같은 명령이 수행된다.     
* 서비스 내에 컨테이너는 1개 이상 존재할 수 있으며 컨테이너들은 각 워커 노드와 매니저 노드에 할당된다. 
* 이러한 컨테이너들을 **컨테이너 태스크**라고 한다.  
  
**예시**
1. 이미지로 서비스를 생성하고, 컨테이너의 수를 3개로 설정한다.   
2. 스웜 스케줄러는 서비스의 정의에 따라 컨테이너를 할당할 적합한 노드를 선정하고,   
   해당 노드에 컨테이너를 분산해서 저장한다. 
3. 각 노드에 컨테이너가 할당된다.(각 노드에 하나씩 할당되지 않을 수 있다.)   
  
이처럼 함께 생성된 컨테이너를 **레플리카**라고 하며,     
서비스에 설정된 레플리카의 수만큼의 컨테이너가 스웜 클러스터내에 존재해야한다.  
    
스웜은 서비스의 컨테이너들에 대한 상태를 계속 확인하고 있다가      
서비스내에 정의된 레플리카의 수만큼 컨테이너가 스웜 클러스터에 존재하지 않으면 새로운 컨테이너 레플리카를 생성한다.   

즉, 컨테이너가 할당된 `노드`가 다운되면 매니저는 사용 가능한 다른 노드에 같은 컨테이너를 생성한다.     
서버가 다운되지 않더라도 서비스내의 컨테이너 중 일부가 작동을 멈춰 정지한 상태도 마찬가지다.     
  
서비스는 롤링 업데이트 기능도 지원한다.    
서비스 내 컨테이너들의 이미지를 일괄적으로 업데이트해야할 때,      
컨테이너들의 이미지를 순서대로 변경해 서비스 자체가 다운되는 시간 없이 컨테이너 업데이트를 진행할 수 있다.    

```
롤링 업데이트는    
여러 개의 서버, 컨테이너등으로 구성된 클러스터의 설정이나 데이터 등을 변경하기 위해 하나씩 재시작하는 것을 의미한다.    
롤링 업데이트를 사용하지 않고 모든 서버나 컨테이너를 한 번에 재시작하면 제공하는 서비스에 다운 시간이 생기지만     
롤링 업데이트를 이용하면 하나를 업데이트해도, 다른 서버나 컨테이너는 작동중이기 때문에 지속적인 서비스가 가능하다.   
```  

### 서비스 생성 
#### 첫번째 서비스 생성해보기  

서비스를 사용하기 위한 명령어는 docker service 로 시작한다.   

```
docker service create \
이미지:태그 \
명령어 
```
* 서비스를 생성하려면 docker service create 명령어를 사용한다.   
* 서비스 내의 컨테이너는 detached 모드로, -d 옵션을 사용해 동작할 수 있는 이미지를 사용해야한다.  
* `docker service create 이미지(프로세스가 없는):태그` 와 같이 사용하면,   
  컨테이너 내부를 차지하고 있는 프로세스가 없어 컨테이너가 정지될 것이고,   
  스웜 매니저는 서비스의 컨테이너에 장애가 생긴것으로 판단해 컨테이너를 계속 반복해서 생성할 것이다.   
* 위 예제는 우분투 컨테이너 내에서 `hello world`를 출력하기에 사용이 가능하다.  





  
 


